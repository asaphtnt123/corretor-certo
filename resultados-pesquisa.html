<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados da Pesquisa - Corretor Certo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .result-card {
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .price-tag {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2a6496;
        }
        .negociacao-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }
        .carregando {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .filtros-ativos {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filtro-tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .no-results {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Cabeçalho e Filtros Ativos -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h2><i class="fas fa-search me-2"></i>Resultados da Pesquisa</h2>
                <div id="filtros-ativos" class="filtros-ativos">
                    <h5>Filtros aplicados:</h5>
                    <div id="filtros-tags"></div>
                </div>
            </div>
        </div>
        
        <!-- Alertas -->
        <div id="alert-container" class="mb-4"></div>
        
        <!-- Estado de Carregamento -->
        <div class="carregando">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Buscando anúncios...</p>
        </div>
        
        <!-- Resultados -->
        <div class="row" id="resultados-container">
            <!-- Os resultados serão inseridos aqui via JavaScript -->
        </div>
        
        <!-- Paginação -->
        <nav aria-label="Page navigation" class="mt-4" id="pagination-container">
            <ul class="pagination justify-content-center">
                <!-- Paginação será gerada dinamicamente -->
            </ul>
        </nav>
        
        <!-- Sem Resultados -->
        <div id="no-results" class="no-results" style="display: none;">
            <i class="fas fa-search fa-3x mb-3"></i>
            <h4>Nenhum anúncio encontrado</h4>
            <p>Não encontramos anúncios que correspondam aos seus critérios de busca.</p>
            <button class="btn btn-primary" onclick="window.history.back()">Ajustar Filtros</button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <!-- JavaScript para Resultados -->
    <script>
        // Configuração do Firebase (use a mesma do seu projeto)
      const firebaseConfig = {
  apiKey: "AIzaSyCNr5JoKsWJVeUYAaVDqmPznZo100v0uvg",
  authDomain: "corretorcerto-76933.firebaseapp.com",
  databaseURL: "https://corretorcerto-76933-default-rtdb.firebaseio.com",
  projectId: "corretorcerto-76933",
  storageBucket: "corretorcerto-76933.firebasestorage.app",
  messagingSenderId: "357149829474",
  appId: "1:357149829474:web:324b2005d82eabbce5e43b"
};
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Função segura para ler do localStorage
        function getLocalStorageSafe(key) {
            try {
                const item = localStorage.getItem(key);
                return item && item !== "undefined" ? JSON.parse(item) : null;
            } catch (e) {
                console.error(`Erro ao ler ${key} do localStorage:`, e);
                localStorage.removeItem(key);
                return null;
            }
        }

        // Função para criar card de anúncio
        function criarCardAnuncio(anuncio, tipo) {
            const colDiv = document.createElement("div");
            colDiv.className = "col-md-6 col-lg-4 mb-4";
            
            const cardDiv = document.createElement("div");
            cardDiv.className = "card h-100";
            
            // Imagem (usa primeira imagem ou placeholder)
            const imgUrl = anuncio.imagens?.length > 0 ? anuncio.imagens[0] : 
                'https://via.placeholder.com/300x200?text=Sem+Imagem';
            
            const img = document.createElement("img");
            img.className = "card-img-top";
            img.src = imgUrl;
            img.alt = anuncio.titulo || "Anúncio sem título";
            
            // Corpo do card
            const cardBody = document.createElement("div");
            cardBody.className = "card-body d-flex flex-column";
            
            const title = document.createElement("h5");
            title.className = "card-title";
            title.textContent = anuncio.titulo || "Anúncio sem título";
            
            const price = document.createElement("div");
            price.className = "price-tag mb-3";
            price.textContent = formatarPreco(anuncio.preco);
            
            // Detalhes específicos
            const details = document.createElement("div");
            details.className = "card-text mb-3";
            
            if (tipo === 'imovel') {
                details.innerHTML = `
                    <p><i class="fas fa-map-marker-alt"></i> ${anuncio.bairro || 'Bairro não informado'}</p>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-secondary"><i class="fas fa-bed"></i> ${anuncio.quartos || 0} quartos</span>
                        <span class="badge bg-secondary"><i class="fas fa-bath"></i> ${anuncio.banheiros || 0} banheiros</span>
                        <span class="badge bg-secondary"><i class="fas fa-car"></i> ${anuncio.garagem || 0} vagas</span>
                        ${anuncio.area ? `<span class="badge bg-secondary"><i class="fas fa-ruler-combined"></i> ${anuncio.area}m²</span>` : ''}
                    </div>
                `;
            } else {
                details.innerHTML = `
                    <p><i class="fas fa-car"></i> ${anuncio.marca || 'Marca não informada'} ${anuncio.modelo || ''}</p>
                    <div class="d-flex flex-wrap gap-2">
                        ${anuncio.ano ? `<span class="badge bg-secondary"><i class="fas fa-calendar-alt"></i> ${anuncio.ano}</span>` : ''}
                        ${anuncio.km ? `<span class="badge bg-secondary"><i class="fas fa-tachometer-alt"></i> ${anuncio.km.toLocaleString()} km</span>` : ''}
                        ${anuncio.combustivel ? `<span class="badge bg-secondary"><i class="fas fa-gas-pump"></i> ${formatarCombustivel(anuncio.combustivel)}</span>` : ''}
                    </div>
                `;
            }
            
            // Botão de detalhes
            const btn = document.createElement("a");
            btn.className = "btn btn-primary mt-auto";
            btn.href = `detalhes.html?id=${anuncio.id}&tipo=${tipo}`;
            btn.textContent = "Ver Detalhes";
            
            // Montar o card
            cardBody.appendChild(title);
            cardBody.appendChild(price);
            cardBody.appendChild(details);
            cardBody.appendChild(btn);
            
            cardDiv.appendChild(img);
            cardDiv.appendChild(cardBody);
            colDiv.appendChild(cardDiv);
            
            return colDiv;
        }

        // Função para mostrar filtros ativos
        function mostrarFiltrosAtivos(params, tipo) {
            const container = document.getElementById("filtros-tags");
            container.innerHTML = "";
            
            let temFiltros = false;
            
            for (const [key, value] of Object.entries(params)) {
                if (value !== undefined && value !== "" && value !== 0 && value !== false) {
                    temFiltros = true;
                    
                    const tag = document.createElement("span");
                    tag.className = "filtro-tag";
                    
                    let label = key;
                    let displayValue = value;
                    
                    // Traduzir chaves para nomes amigáveis
                    switch(key) {
                        case 'bairro': label = 'Bairro'; break;
                        case 'tipo': label = tipo === 'imovel' ? 'Tipo Imóvel' : 'Marca'; break;
                        case 'precoMin': label = 'Preço Mínimo'; displayValue = formatarPreco(value); break;
                        case 'precoMax': label = 'Preço Máximo'; displayValue = formatarPreco(value); break;
                        case 'quartos': label = 'Quartos'; displayValue = value + '+'; break;
                        case 'banheiros': label = 'Banheiros'; displayValue = value + '+'; break;
                        case 'garagem': label = 'Vagas'; displayValue = value + '+'; break;
                        case 'areaMin': label = 'Área Mínima'; displayValue = value + 'm²'; break;
                        case 'aceitaAnimais': label = 'Aceita Animais'; displayValue = ''; break;
                        case 'mobiliado': label = 'Mobiliado'; displayValue = ''; break;
                        case 'modelo': label = 'Modelo'; break;
                        case 'ano': label = 'Ano'; break;
                        case 'negociacao': label = 'Negociação'; displayValue = value === 'venda' ? 'Venda' : 'Aluguel'; break;
                        case 'kmMax': label = 'KM Máxima'; displayValue = value.toLocaleString() + ' km'; break;
                        case 'combustivel': label = 'Combustível'; displayValue = formatarCombustivel(value); break;
                        case 'cambio': label = 'Câmbio'; displayValue = value === 'automatico' ? 'Automático' : 'Manual'; break;
                    }
                    
                    tag.innerHTML = `<strong>${label}:</strong> ${displayValue}`;
                    container.appendChild(tag);
                }
            }
            
            document.getElementById("filtros-ativos").style.display = temFiltros ? "block" : "none";
        }

        // Carregar e exibir resultados
        function loadAndDisplayResults() {
            const resultadosContainer = document.getElementById("resultados-container");
            const noResultsDiv = document.getElementById("no-results");
            const carregandoDiv = document.querySelector(".carregando");
            
            // Resetar exibição
            resultadosContainer.innerHTML = "";
            noResultsDiv.style.display = "none";
            carregandoDiv.style.display = "block";
            
            // Obter dados com tratamento seguro
            const resultados = getLocalStorageSafe('searchResults') || [];
            const params = getLocalStorageSafe('searchParams') || {};
            
            // Verificar se temos parâmetros válidos
            if (params.tipoAnuncio) {
                mostrarFiltrosAtivos(params, params.tipoAnuncio);
                
                if (resultados.length > 0) {
                    resultados.forEach(anuncio => {
                        resultadosContainer.appendChild(criarCardAnuncio(anuncio, params.tipoAnuncio));
                    });
                    document.querySelector("h2").innerHTML = `Resultados da Pesquisa <span class="badge bg-primary">${resultados.length}</span>`;
                } else {
                    noResultsDiv.style.display = "block";
                }
            } else {
                noResultsDiv.style.display = "block";
                noResultsDiv.querySelector("p").textContent = "Nenhum critério de pesquisa foi definido.";
            }
            
            carregandoDiv.style.display = "none";
        }

        // Iniciar o carregamento
        setTimeout(loadAndDisplayResults, 100);
    });
</script>
</body>
</html>
