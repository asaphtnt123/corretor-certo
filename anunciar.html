<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Anúncio - Corretor Certo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .header {
            background-color: var(--secondary-color);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-title {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .type-selector {
            margin-bottom: 2rem;
        }
        
        .type-btn {
            width: 100%;
            padding: 1rem;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .type-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            background-color: var(--secondary-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header text-center">
        <div class="container">
            <h1><i class="fas fa-bullhorn me-2"></i>Criar Novo Anúncio</h1>
            <p class="lead">Preencha os detalhes do seu anúncio abaixo</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Form Container -->
                <div class="form-container">
                  <!-- Adicione name aos campos obrigatórios -->
<select class="form-select" id="tipo-imovel" name="tipo-imovel" required>
    <option value="" disabled selected>Selecione o tipo</option>
    <option value="casa">Casa</option>
    <option value="apartamento">Apartamento</option>
    <option value="terreno">Terreno</option>
    <option value="comercial">Comercial</option>
</select>

<input type="text" class="form-control" id="bairro" name="bairro" required placeholder="Digite o bairro">

                    <!-- Common Fields -->
                    <form id="anuncio-form">
                        <h3 class="form-title">Informações Básicas</h3>
                        
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título do Anúncio*</label>
                            <input type="text" class="form-control" id="titulo" required placeholder="Ex: Apartamento 3 quartos no Centro">
                        </div>
                        
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição Detalhada*</label>
                            <textarea class="form-control" id="descricao" rows="4" required placeholder="Descreva o seu anúncio com detalhes"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="preco" class="form-label">Preço (R$)*</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" id="preco" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="imagens" class="form-label">Imagens*</label>
                                <input type="file" class="form-control" id="imagens" multiple accept="image/*" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Pré-visualização das Imagens</label>
                            <div class="image-preview-container" id="image-preview">
                                <p class="text-muted">Nenhuma imagem selecionada</p>
                            </div>
                        </div>

                        <!-- Imóvel Fields -->
                        <div id="imovel-fields">
                            <h3 class="form-title">Detalhes do Imóvel</h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tipo-imovel" class="form-label">Tipo de Imóvel*</label>
                                    <select class="form-select" id="tipo-imovel" required>
                                        <option value="" selected disabled>Selecione...</option>
                                        <option value="casa">Casa</option>
                                        <option value="apartamento">Apartamento</option>
                                        <option value="terreno">Terreno</option>
                                        <option value="comercial">Imóvel Comercial</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="bairro" class="form-label">Bairro*</label>
                                    <input type="text" class="form-control" id="bairro" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="quartos" class="form-label">Quartos</label>
                                    <input type="number" class="form-control" id="quartos" min="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="banheiros" class="form-label">Banheiros</label>
                                    <input type="number" class="form-control" id="banheiros" min="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="area" class="form-label">Área (m²)</label>
                                    <input type="number" class="form-control" id="area" min="0" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Automóvel Fields -->
                        <div id="automovel-fields" class="hidden">
                            <h3 class="form-title">Detalhes do Automóvel</h3>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="marca" class="form-label">Marca*</label>
                                    <input type="text" class="form-control" id="marca" placeholder="Ex: Toyota">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="modelo" class="form-label">Modelo*</label>
                                    <input type="text" class="form-control" id="modelo" placeholder="Ex: Corolla">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ano" class="form-label">Ano*</label>
                                    <input type="number" class="form-control" id="ano" min="1900" max="2023">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="km" class="form-label">Quilometragem</label>
                                    <input type="number" class="form-control" id="km" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Publicar Anúncio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center">
        <div class="container">
            <p>&copy; 2023 Corretor Certo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase v9 (modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-7HOp-Ycvyf3b_03ev__8aJEwAbWSQZY",
            authDomain: "connectfamilia-312dc.firebaseapp.com",
            projectId: "connectfamilia-312dc",
            storageBucket: "connectfamilia-312dc.appspot.com",
            messagingSenderId: "797817838649",
            appId: "1:797817838649:web:1aa7c54abd97661f8d81e8",
            measurementId: "G-QKN9NFXZZQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // DOM Elements
        const btnImovel = document.getElementById('btn-imovel');
        const btnAutomovel = document.getElementById('btn-automovel');
        const imovelFields = document.getElementById('imovel-fields');
        const automovelFields = document.getElementById('automovel-fields');
        const anuncioForm = document.getElementById('anuncio-form');
        const imageInput = document.getElementById('imagens');
        const imagePreview = document.getElementById('image-preview');

        // Type Selection
        btnImovel.addEventListener('click', () => {
            btnImovel.classList.add('active');
            btnAutomovel.classList.remove('active');
            imovelFields.classList.remove('hidden');
            automovelFields.classList.add('hidden');
        });

        btnAutomovel.addEventListener('click', () => {
            btnAutomovel.classList.add('active');
            btnImovel.classList.remove('active');
            automovelFields.classList.remove('hidden');
            imovelFields.classList.add('hidden');
        });

        // Image Preview
        imageInput.addEventListener('change', function() {
            imagePreview.innerHTML = '';
            if (this.files.length === 0) {
                imagePreview.innerHTML = '<p class="text-muted">Nenhuma imagem selecionada</p>';
                return;
            }
            
            for (let i = 0; i < this.files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('image-preview');
                    imagePreview.appendChild(img);
                }
                reader.readAsDataURL(this.files[i]);
            }
        });

        // Form Submission
        anuncioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                alert('Você precisa estar logado para criar anúncios!');
                window.location.href = 'login.html';
                return;
            }
            
            // Get form values
            const titulo = document.getElementById('titulo').value;
            const descricao = document.getElementById('descricao').value;
            const preco = parseFloat(document.getElementById('preco').value);
            const imagens = document.getElementById('imagens').files;
            const isImovel = btnImovel.classList.contains('active');
            
            // Validate required fields
            if (!titulo || !descricao || isNaN(preco) || imagens.length === 0) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            try {
                // Upload images
                const imageUrls = [];
                for (let i = 0; i < imagens.length; i++) {
                    const file = imagens[i];
                    const storageRef = ref(storage, `anuncios/${user.uid}/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snapshot.ref);
                    imageUrls.push(url);
                }
                
                // Create announcement data
                const anuncioData = {
                    titulo,
                    descricao,
                    preco,
                    imagens: imageUrls,
                    userId: user.uid,
                    data: new Date(),
                    destaque: false
                };
                
                // Add type-specific fields
                if (isImovel) {
                    anuncioData.tipo = document.getElementById('tipo-imovel').value;
                    anuncioData.bairro = document.getElementById('bairro').value;
                    anuncioData.quartos = parseInt(document.getElementById('quartos').value) || 0;
                    anuncioData.banheiros = parseInt(document.getElementById('banheiros').value) || 0;
                    anuncioData.area = parseFloat(document.getElementById('area').value) || 0;
                    
                    // Save to Firestore
                    await addDoc(collection(db, 'imoveis'), anuncioData);
                } else {
                    anuncioData.marca = document.getElementById('marca').value;
                    anuncioData.modelo = document.getElementById('modelo').value;
                    anuncioData.ano = parseInt(document.getElementById('ano').value);
                    anuncioData.km = parseInt(document.getElementById('km').value) || 0;
                    
                    // Save to Firestore
                    await addDoc(collection(db, 'automoveis'), anuncioData);
                }
                
                alert('Anúncio criado com sucesso!');
                window.location.href = 'perfil.html#anuncios';
            } catch (error) {
                console.error('Erro ao criar anúncio:', error);
                alert('Erro ao criar anúncio: ' + error.message);
            }
        });

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
