<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ✅ SEO Essencial -->
    <title>Editar Anúncio | Corretor Certo</title>
    <meta name="description" content="Edite seu anúncio de imóveis ou veículos na plataforma Corretor Certo. Atualize informações, imagens e preços de forma rápida e fácil." />
    <meta name="keywords" content="editar anúncio, modificar anúncio, editar imóvel, editar carro, Corretor Certo, anúncios imobiliários, anúncios de veículos" />
    <meta name="author" content="Corretor Certo" />
    <link rel="canonical" href="https://corretorcerto.com.br/editar-anuncio" />

    <!-- ✅ Open Graph (Facebook, WhatsApp, LinkedIn) -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Editar Anúncio | Corretor Certo" />
    <meta property="og:description" content="Edite seu anúncio de imóveis ou veículos no Corretor Certo, ajustando todas as informações de maneira simples e eficaz." />
    <meta property="og:image" content="https://corretorcerto.com.br/assets/img/og-image-editar-anuncio.jpg" /> <!-- Substitua por sua imagem real -->
    <meta property="og:url" content="https://corretorcerto.com.br/editar-anuncio" />
    <meta property="og:site_name" content="Corretor Certo" />

    <!-- ✅ Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Editar Anúncio | Corretor Certo" />
    <meta name="twitter:description" content="Modifique os detalhes do seu anúncio de imóvel ou veículo no Corretor Certo para garantir que ele esteja sempre atualizado e atraente." />
    <meta name="twitter:image" content="https://corretorcerto.com.br/assets/img/og-image-editar-anuncio.jpg" />

    <!-- ✅ Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

    <!-- ✅ Fontes e Estilo -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- ✅ Font Awesome Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- ✅ Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ✅ CSS Personalizado -->
    <link rel="stylesheet" href="editaranuncio.css">

    <!-- ✅ Personalização do Estilo -->
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .form-section h3 {
            color: #0d6efd;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <h1 class="text-center mb-4"><i class="fas fa-edit me-2"></i>Editar Anúncio</h1>
        
        <form id="form-editar">
            <!-- Seção de Informações Básicas -->
            <div class="form-section">
                <h3><i class="fas fa-info-circle me-2"></i>Informações Básicas</h3>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="titulo" class="form-label">Título *</label>
                        <input type="text" class="form-control" id="titulo" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="preco" class="form-label">Preço (R$) *</label>
                        <input type="number" class="form-control" id="preco" step="0.01" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição *</label>
                    <textarea class="form-control" id="descricao" rows="4" required></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">Status *</label>
                        <select class="form-select" id="status" required>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="destaque">
                            <label class="form-check-label" for="destaque">Destacar anúncio</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Detalhes do Imóvel -->
            <div class="form-section hidden" id="secao-imovel">
                <h3><i class="fas fa-home me-2"></i>Detalhes do Imóvel</h3>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="quartos" class="form-label">Quartos</label>
                        <input type="number" class="form-control" id="quartos">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="banheiros" class="form-label">Banheiros</label>
                        <input type="number" class="form-control" id="banheiros">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="garagem" class="form-label">Vagas</label>
                        <input type="number" class="form-control" id="garagem">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="area" class="form-label">Área (m²)</label>
                        <input type="number" class="form-control" id="area">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tipo_imovel" class="form-label">Tipo de Imóvel</label>
                        <select class="form-select" id="tipo_imovel">
                            <option value="casa">Casa</option>
                            <option value="apartamento">Apartamento</option>
                            <option value="terreno">Terreno</option>
                            <option value="comercial">Comercial</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Seção de Detalhes do Automóvel -->
            <div class="form-section hidden" id="secao-automovel">
                <h3><i class="fas fa-car me-2"></i>Detalhes do Automóvel</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="marca" class="form-label">Marca</label>
                        <input type="text" class="form-control" id="marca">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" class="form-control" id="modelo">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="ano" class="form-label">Ano</label>
                        <input type="number" class="form-control" id="ano" min="1900" max="2099">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="km" class="form-label">Quilometragem</label>
                        <input type="number" class="form-control" id="km">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="cor" class="form-label">Cor</label>
                        <input type="text" class="form-control" id="cor">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="combustivel" class="form-label">Combustível</label>
                        <select class="form-select" id="combustivel">
                            <option value="gasolina">Gasolina</option>
                            <option value="alcool">Álcool</option>
                            <option value="flex">Flex</option>
                            <option value="diesel">Diesel</option>
                            <option value="eletrico">Elétrico</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Seção de Imagens -->
            <div class="form-section">
                <h3><i class="fas fa-images me-2"></i>Imagens</h3>
                <div class="mb-3">
                    <label for="imagens" class="form-label">Adicionar novas imagens</label>
                    <input class="form-control" type="file" id="imagens" multiple accept="image/*">
                </div>
                <div id="preview-imagens" class="d-flex flex-wrap gap-2 mb-3"></div>
                <div id="galeria-imagens" class="d-flex flex-wrap gap-2"></div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="perfil.html" class="btn btn-secondary me-md-2">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Salvar Alterações
                </button>
            </div>
        </form>
    </div>

    <!-- SweetAlert2 para mensagens bonitas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase SDKs (versão 8 - abordagem tradicional) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
       const firebaseConfig = {
  apiKey: "AIzaSyCNr5JoKsWJVeUYAaVDqmPznZo100v0uvg",
  authDomain: "corretorcerto-76933.firebaseapp.com",
  databaseURL: "https://corretorcerto-76933-default-rtdb.firebaseio.com",
  projectId: "corretorcerto-76933",
  storageBucket: "corretorcerto-76933.firebasestorage.app",
  messagingSenderId: "357149829474",
  appId: "1:357149829474:web:324b2005d82eabbce5e43b"
};

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Captura os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const tipo = urlParams.get('tipo');
        const collectionName = tipo === "imovel" ? "imoveis" : "automoveis";

        // Função para carregar os dados do anúncio
        async function carregarDadosAnuncio() {
            try {
                const docRef = db.collection(collectionName).doc(id);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const anuncio = docSnap.data();
                    
                    // Preenche campos básicos
                    document.getElementById("titulo").value = anuncio.titulo || "";
                    document.getElementById("descricao").value = anuncio.descricao || "";
                    document.getElementById("preco").value = anuncio.preco || "";
                    document.getElementById("status").value = anuncio.status || "ativo";
                    document.getElementById("destaque").checked = anuncio.destaque || false;
                    
                    // Preenche campos específicos
                    if (tipo === "imovel") {
                        document.getElementById("secao-imovel").classList.remove("hidden");
                        document.getElementById("quartos").value = anuncio.quartos || "";
                        document.getElementById("banheiros").value = anuncio.banheiros || "";
                        document.getElementById("garagem").value = anuncio.garagem || "";
                        document.getElementById("area").value = anuncio.area || "";
                        document.getElementById("bairro").value = anuncio.bairro || "";
                        document.getElementById("tipo_imovel").value = anuncio.tipo_imovel || "casa";
                    } else {
                        document.getElementById("secao-automovel").classList.remove("hidden");
                        document.getElementById("marca").value = anuncio.marca || "";
                        document.getElementById("modelo").value = anuncio.modelo || "";
                        document.getElementById("ano").value = anuncio.ano || "";
                        document.getElementById("km").value = anuncio.km || "";
                        document.getElementById("cor").value = anuncio.cor || "";
                        document.getElementById("combustivel").value = anuncio.combustivel || "gasolina";
                    }
                    
                    // Exibe as imagens existentes (se houver)
                    if (anuncio.imagens && anuncio.imagens.length > 0) {
                        const galeria = document.getElementById("galeria-imagens");
                        galeria.innerHTML = ""; // Limpa qualquer conteúdo anterior
                        anuncio.imagens.forEach(url => {
                            galeria.innerHTML += `
                                <div class="position-relative" style="width: 150px;">
                                    <img src="${url}" class="img-thumbnail" style="height: 100px; object-fit: cover;">
                                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="removerImagem('${url}', '${id}', '${tipo}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                        });
                    }
                } else {
                    throw new Error("Anúncio não encontrado");
                }
            } catch (error) {
                console.error("Erro ao carregar anúncio:", error);
                Swal.fire({
                    title: 'Erro!',
                    text: 'Não foi possível carregar os dados do anúncio',
                    icon: 'error'
                }).then(() => {
                    window.location.href = "perfil.html";
                });
            }
        }

        // Função para remover imagem
        window.removerImagem = async function(url, anuncioId, tipoAnuncio) {
            try {
                const result = await Swal.fire({
                    title: 'Remover imagem?',
                    text: "Esta ação não pode ser desfeita!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim, remover!'
                });

                if (result.isConfirmed) {
                    // Extrai o caminho da URL da imagem
                    const path = decodeURIComponent(url.split('/o/')[1].split('?')[0]);
                    
                    // Remove do Storage
                    const imageRef = storage.ref(path);
                    await imageRef.delete();
                    
                    // Remove do array de imagens no documento
                    const collection = tipoAnuncio === "imovel" ? "imoveis" : "automoveis";
                    await db.collection(collection).doc(anuncioId).update({
                        imagens: firebase.firestore.FieldValue.arrayRemove(url)
                    });
                    
                    // Recarrega os dados
                    await carregarDadosAnuncio();
                    
                    Swal.fire('Removida!', 'A imagem foi removida com sucesso.', 'success');
                }
            } catch (error) {
                console.error("Erro ao remover imagem:", error);
                Swal.fire('Erro!', 'Não foi possível remover a imagem', 'error');
            }
        };

        // Preview de novas imagens antes de enviar
        document.getElementById("imagens").addEventListener("change", function(e) {
            const preview = document.getElementById("preview-imagens");
            preview.innerHTML = "";
            
            for (const file of e.target.files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    preview.innerHTML += `
                        <div class="position-relative" style="width: 150px;">
                            <img src="${event.target.result}" class="img-thumbnail" style="height: 100px; object-fit: cover;">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        // Função para fazer upload de imagens
        async function uploadImagens(files, anuncioId) {
            const urls = [];
            for (const file of files) {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`anuncios/${anuncioId}/${file.name}`);
                await fileRef.put(file);
                const url = await fileRef.getDownloadURL();
                urls.push(url);
            }
            return urls;
        }

        // Envio do formulário
        document.getElementById("form-editar").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("Usuário não autenticado");
                
                // Dados básicos
                const dadosAtualizados = {
                    titulo: document.getElementById("titulo").value,
                    descricao: document.getElementById("descricao").value,
                    preco: parseFloat(document.getElementById("preco").value),
                    status: document.getElementById("status").value,
                    destaque: document.getElementById("destaque").checked,
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Dados específicos
                if (tipo === "imovel") {
                    dadosAtualizados.quartos = parseInt(document.getElementById("quartos").value) || 0;
                    dadosAtualizados.banheiros = parseInt(document.getElementById("banheiros").value) || 0;
                    dadosAtualizados.garagem = parseInt(document.getElementById("garagem").value) || 0;
                    dadosAtualizados.area = parseInt(document.getElementById("area").value) || 0;
                    dadosAtualizados.bairro = document.getElementById("bairro").value;
                    dadosAtualizados.tipo_imovel = document.getElementById("tipo_imovel").value;
                } else {
                    dadosAtualizados.marca = document.getElementById("marca").value;
                    dadosAtualizados.modelo = document.getElementById("modelo").value;
                    dadosAtualizados.ano = parseInt(document.getElementById("ano").value) || 0;
                    dadosAtualizados.km = parseInt(document.getElementById("km").value) || 0;
                    dadosAtualizados.cor = document.getElementById("cor").value;
                    dadosAtualizados.combustivel = document.getElementById("combustivel").value;
                }
                
                // Upload de novas imagens
                const files = document.getElementById("imagens").files;
                if (files.length > 0) {
                    const novasImagens = await uploadImagens(files, id);
                    dadosAtualizados.imagens = firebase.firestore.FieldValue.arrayUnion(...novasImagens);
                }
                
                // Atualiza no Firestore
                await db.collection(collectionName).doc(id).update(dadosAtualizados);
                
                Swal.fire({
                    title: 'Sucesso!',
                    text: 'Anúncio atualizado com sucesso',
                    icon: 'success'
                }).then(() => {
                    window.location.href = "perfil.html";
                });
                
            } catch (error) {
                console.error("Erro ao atualizar anúncio:", error);
                Swal.fire({
                    title: 'Erro!',
                    text: 'Não foi possível atualizar o anúncio: ' + error.message,
                    icon: 'error'
                });
            }
        });

        // Carrega os dados quando a página estiver pronta
        document.addEventListener("DOMContentLoaded", function() {
            // Verifica autenticação
            auth.onAuthStateChanged(user => {
                if (user) {
                    carregarDadosAnuncio();
                } else {
                    window.location.href = "login.html";
                }
            });
        });
    </script>
</body>
</html>
