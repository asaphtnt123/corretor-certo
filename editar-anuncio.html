<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Anúncio</title>
    <style>
        .form-step { display: none; }
        .form-step.active { display: block; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
    </style>
    <!-- Adicione o SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <form id="multiStepForm">
        <!-- Passo 1 - Informações Básicas -->
        <div class="form-step active" id="step-1">
            <h2>Informações Básicas</h2>
            
            <label for="titulo">Título:</label>
            <input type="text" id="titulo" required>
            
            <label for="descricao">Descrição:</label>
            <textarea id="descricao" required></textarea>
            
            <label for="preco">Preço (R$):</label>
            <input type="number" id="preco" step="0.01" required>
            
            <div>
                <label for="status">Status:</label>
                <select id="status" required>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
            
            <div>
                <input type="checkbox" id="destaque">
                <label for="destaque">Destacar anúncio</label>
            </div>
            
            <button type="button" class="next-step">Próximo</button>
        </div>

        <!-- Passo 2 - Campos Específicos -->
        <div class="form-step" id="step-2">
            <h2>Detalhes Específicos</h2>
            
            <!-- Seção Imóvel (inicialmente oculta) -->
            <div id="secao-imovel" class="hidden">
                <label for="quartos">Quartos:</label>
                <input type="number" id="quartos">
                
                <label for="banheiros">Banheiros:</label>
                <input type="number" id="banheiros">
                
                <label for="garagem">Vagas na Garagem:</label>
                <input type="number" id="garagem">
                
                <label for="area">Área (m²):</label>
                <input type="number" id="area">
                
                <label for="bairro">Bairro:</label>
                <input type="text" id="bairro">
            </div>
            
            <!-- Seção Automóvel (inicialmente oculta) -->
            <div id="secao-automovel" class="hidden">
                <label for="marca">Marca:</label>
                <input type="text" id="marca">
                
                <label for="modelo">Modelo:</label>
                <input type="text" id="modelo">
                
                <label for="ano">Ano:</label>
                <input type="number" id="ano" min="1900" max="2099">
                
                <label for="km">Quilometragem:</label>
                <input type="number" id="km">
                
                <label for="cor">Cor:</label>
                <input type="text" id="cor">
            </div>
            
            <button type="button" class="prev-step">Voltar</button>
            <button type="button" class="next-step">Próximo</button>
        </div>

        <!-- Passo 3 - Imagens -->
        <div class="form-step" id="step-3">
            <h2>Imagens do Anúncio</h2>
            <input type="file" id="imagens" multiple>
            
            <div id="preview-imagens"></div>
            
            <button type="button" class="prev-step">Voltar</button>
            <button type="submit">Salvar Alterações</button>
        </div>
    </form>

    <script>
        // Configuração básica do Firebase (substitua com sua configuração)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_DOMINIO.firebaseapp.com",
            projectId: "SEU_PROJETO_ID",
            storageBucket: "SEU_BUCKET.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Inicialize o Firebase (certifique-se de ter os scripts importados)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Captura os parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const tipo = urlParams.get('tipo');
        const collectionName = tipo === "imovel" ? "imoveis" : "automoveis";

        // Variáveis para controle do formulário
        let currentStep = 1;
        const steps = document.querySelectorAll(".form-step");

        // Função para carregar os dados do anúncio
        async function carregarDadosAnuncio() {
            try {
                const docRef = db.collection(collectionName).doc(id);
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    const anuncio = docSnap.data();
                    
                    // Preenche os campos básicos
                    document.getElementById("titulo").value = anuncio.titulo || "";
                    document.getElementById("descricao").value = anuncio.descricao || "";
                    document.getElementById("preco").value = anuncio.preco || "";
                    document.getElementById("status").value = anuncio.status || "ativo";
                    document.getElementById("destaque").checked = anuncio.destaque || false;
                    
                    // Preenche os campos específicos
                    if (tipo === "imovel") {
                        document.getElementById("secao-imovel").classList.remove("hidden");
                        document.getElementById("quartos").value = anuncio.quartos || "";
                        document.getElementById("banheiros").value = anuncio.banheiros || "";
                        document.getElementById("garagem").value = anuncio.garagem || "";
                        document.getElementById("area").value = anuncio.area || "";
                        document.getElementById("bairro").value = anuncio.bairro || "";
                    } else {
                        document.getElementById("secao-automovel").classList.remove("hidden");
                        document.getElementById("marca").value = anuncio.marca || "";
                        document.getElementById("modelo").value = anuncio.modelo || "";
                        document.getElementById("ano").value = anuncio.ano || "";
                        document.getElementById("km").value = anuncio.km || "";
                        document.getElementById("cor").value = anuncio.cor || "";
                    }
                    
                    // Se houver imagens, exibe preview (implemente conforme necessidade)
                    if (anuncio.imagens && anuncio.imagens.length > 0) {
                        // Lógica para exibir preview das imagens existentes
                    }
                } else {
                    Swal.fire("Erro", "Anúncio não encontrado", "error").then(() => {
                        window.location.href = "perfil.html";
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar anúncio:", error);
                Swal.fire("Erro", "Ocorreu um erro ao carregar o anúncio", "error");
            }
        }

        // Funções para controle do formulário multi-etapas
        function showStep(step) {
            steps.forEach((s, index) => {
                s.classList.toggle("active", index + 1 === step);
            });
            currentStep = step;
        }

        function checkFormValidity() {
            const currentStepForm = document.getElementById(`step-${currentStep}`);
            const inputs = currentStepForm.querySelectorAll("[required]");
            const nextButton = currentStepForm.querySelector(".next-step") || 
                              currentStepForm.querySelector("button[type='submit']");
            
            if (nextButton) {
                let isValid = true;
                inputs.forEach(input => {
                    if (!input.value.trim()) isValid = false;
                });
                nextButton.disabled = !isValid;
            }
        }

        // Event Listeners
        document.addEventListener("DOMContentLoaded", () => {
            // Carrega os dados quando a página estiver pronta
            carregarDadosAnuncio();
            
            // Configura a validação em tempo real
            document.querySelectorAll("input, textarea, select").forEach(input => {
                input.addEventListener("input", checkFormValidity);
            });

            // Configura os botões de navegação
            document.querySelectorAll(".next-step").forEach(button => {
                button.addEventListener("click", () => {
                    if (currentStep < steps.length) showStep(currentStep + 1);
                });
            });

            document.querySelectorAll(".prev-step").forEach(button => {
                button.addEventListener("click", () => {
                    if (currentStep > 1) showStep(currentStep - 1);
                });
            });
        });

        // Envio do formulário
        document.getElementById("multiStepForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            try {
                const dadosAtualizados = {
                    titulo: document.getElementById("titulo").value,
                    descricao: document.getElementById("descricao").value,
                    preco: parseFloat(document.getElementById("preco").value),
                    status: document.getElementById("status").value,
                    destaque: document.getElementById("destaque").checked,
                    dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Adiciona campos específicos
                if (tipo === "imovel") {
                    dadosAtualizados.quartos = parseInt(document.getElementById("quartos").value) || 0;
                    dadosAtualizados.banheiros = parseInt(document.getElementById("banheiros").value) || 0;
                    dadosAtualizados.garagem = parseInt(document.getElementById("garagem").value) || 0;
                    dadosAtualizados.area = parseInt(document.getElementById("area").value) || 0;
                    dadosAtualizados.bairro = document.getElementById("bairro").value;
                } else {
                    dadosAtualizados.marca = document.getElementById("marca").value;
                    dadosAtualizados.modelo = document.getElementById("modelo").value;
                    dadosAtualizados.ano = parseInt(document.getElementById("ano").value) || 0;
                    dadosAtualizados.km = parseInt(document.getElementById("km").value) || 0;
                    dadosAtualizados.cor = document.getElementById("cor").value;
                }

                // Atualiza no Firestore
                await db.collection(collectionName).doc(id).update(dadosAtualizados);
                
                Swal.fire("Sucesso", "Anúncio atualizado com sucesso!", "success").then(() => {
                    window.location.href = "perfil.html";
                });
                
            } catch (error) {
                console.error("Erro ao atualizar anúncio:", error);
                Swal.fire("Erro", "Não foi possível atualizar o anúncio", "error");
            }
        });
    </script>
    
    <!-- Importe os scripts do Firebase no final do body -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
</body>
</html>
